<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.24" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Makefile 基础 | MGKL's Note</title><meta name="description" content="曾晓生命脆弱，未料如此不堪">
    <link rel="preload" href="/assets/style-v9YVb9qz.css" as="style"><link rel="stylesheet" href="/assets/style-v9YVb9qz.css">
    <link rel="modulepreload" href="/assets/app-CkPgLnmy.js"><link rel="modulepreload" href="/assets/makefile.html-DsSTmRth.js">
    <link rel="prefetch" href="/assets/index.html-P0dHuTJc.js" as="script"><link rel="prefetch" href="/assets/data_structure.html-Okyy5Yvo.js" as="script"><link rel="prefetch" href="/assets/cpp_concurrency_programming.html-DeMC_iHZ.js" as="script"><link rel="prefetch" href="/assets/cpp_design_pattern.html-BKRFw7fM.js" as="script"><link rel="prefetch" href="/assets/cpp_interview.html-BuXpS3uc.js" as="script"><link rel="prefetch" href="/assets/cpp_lambda_expr.html-C17BiuTa.js" as="script"><link rel="prefetch" href="/assets/read_write_lock.html-BN5NK0lS.js" as="script"><link rel="prefetch" href="/assets/TCP_IP.html-C91nxB5N.js" as="script"><link rel="prefetch" href="/assets/hiredis_usage.html-Dq3AZOo0.js" as="script"><link rel="prefetch" href="/assets/gdb.html-BXkGUCCT.js" as="script"><link rel="prefetch" href="/assets/git.html-6dZjwx_Q.js" as="script"><link rel="prefetch" href="/assets/404.html-wD3O6Kj5.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">MGKL&#39;s Note</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/mgkl92/mgkl92.github.io" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/mgkl92/mgkl92.github.io" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">Makefile 基础 <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h1 id="makefile-基础" tabindex="-1"><a class="header-anchor" href="#makefile-基础"><span>Makefile 基础</span></a></h1><h3 id="构建-规则、目标和依赖" tabindex="-1"><a class="header-anchor" href="#构建-规则、目标和依赖"><span>（构建）规则、目标和依赖</span></a></h3><p>规则由目标（Targets）、依赖（prerequisites / dependencies）和命令三部分组成；其中，目标为构建规则需要生成的文件、依赖为生成目标文件所需要的依赖文件，而命令指导构建系统如何使用依赖文件生成目标文件。</p><p>其基本语法如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    targets <span class="token builtin class-name">:</span> prerequisites</span>
<span class="line">        command<span class="token punctuation">(</span>s<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="make-的本质" tabindex="-1"><a class="header-anchor" href="#make-的本质"><span>Make 的本质</span></a></h3><p>首先，应该明白，<strong>目标 ≠ 文件</strong>，且当执行构建规则时，其最终期望的结果是生成与目标同名的文件。</p><p>构建规则在以下两种情况尝试运行规则中的命令去构建目标文件：</p><ol><li>构建目标文件尚未生成；</li><li><strong>构建目标依赖文件在目标文件生成后发生变更（构建系统对比目标文件与依赖文件的时间戳）。</strong></li></ol><h3 id="变量" tabindex="-1"><a class="header-anchor" href="#变量"><span>变量</span></a></h3><p>Make 中，变量只能为字符串（即仅支持字符串类型）；且 Make 并不识别引号（单引号或双引号），即引号对 Make 无特殊含义。</p><p>其基本语法为</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    <span class="token comment"># 定义变量</span></span>
<span class="line">    var :<span class="token operator">=</span> val</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 引用变量</span></span>
<span class="line">    <span class="token variable"><span class="token variable">$(</span>var<span class="token variable">)</span></span> or <span class="token variable">${var}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p><strong><code>=</code> 递归赋值</strong></p><p>当且仅当命令执行时，定义该变量；</p></li><li><p><strong><code>:=</code> 展开赋值</strong></p><p>该方式允许你追加变量；且在变量定义时，直接对变量展开。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    one <span class="token operator">=</span> hello</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># hello -&gt; hello there</span></span>
<span class="line">    one :<span class="token operator">=</span> <span class="token variable">${one}</span> there</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># `one = ${one} there` will cause an error.</span></span>
<span class="line"></span>
<span class="line">    all: </span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span>one<span class="token variable">)</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong><code>+=</code> 追加赋值</strong></p></li><li><p><strong><code>?=</code> 仅当变量未定义时定义该变量</strong></p></li></ol><blockquote><p>注：当引用未定义变量时，其值为空。</p></blockquote><h3 id="通配符" tabindex="-1"><a class="header-anchor" href="#通配符"><span>通配符</span></a></h3><ol><li><p><code>*</code> 用于搜索文件系统以匹配文件名称；但未匹配到任何文件名时，该通配符会保留；因此，<code>*</code> 一般不直接使用，通过与 <code>wildcard</code> 函数组合使用。</p><p>如</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    <span class="token comment"># 匹配所有 .c 文件</span></span>
<span class="line">    <span class="token variable"><span class="token variable">$(</span>wildcard *.c<span class="token variable">)</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>%</code> 当处于 <strong>匹配模式</strong> 时，该通配符会将匹配到的一个或多个字符串作为 <em>词干（stem）</em>；当处于 <strong>替换模式</strong> 时，该通配符会将匹配位置替换为词干。</p></li></ol><h3 id="自动变量" tabindex="-1"><a class="header-anchor" href="#自动变量"><span>自动变量</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    <span class="token comment"># 目标名称（当有多个目标时，匹配当前生成目标）</span></span>
<span class="line">    <span class="token variable">$@</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 所有时间戳比目标文件新的依赖文件</span></span>
<span class="line">    <span class="token variable">$?</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 所有依赖文件</span></span>
<span class="line">    $^</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 第一个依赖文件</span></span>
<span class="line">    $<span class="token operator">&lt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="魔法规则" tabindex="-1"><a class="header-anchor" href="#魔法规则"><span>魔法规则</span></a></h3><ol><li><p><strong>隐式规则</strong></p><p>当需要相应依赖时，Make 将自动执行 <code>$(CC) -c $(CPPFLAGS) $(CFLAGS) $^ -o $@</code> 或 <code>$(CXX) -c $(CPPFLAGS) $(CXXFLAGS) $^ -o $@</code> 将相应的 <code>n.c</code> 文件或 <code>n.cc / n.cpp</code> 文件生成其相应的目标文件 <code>n.o</code>；此外，Make 也可以自动的执行 <code>$(CC) $(LDFLAGS) $^ $(LOADLIBES) $(LDLIBS) -o $@</code> 为你将单个文件 <code>n.o</code> 链接到 <code>n</code>。</p></li><li><p><strong>静态模式规则</strong></p><p>基本语法为</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    targets<span class="token punctuation">..</span>.: target-pattern: prereq-patterns <span class="token punctuation">..</span>.</span>
<span class="line">        commands</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>上述规则会为所有的目标文件生成构建规则并为匹配的目标文件生成相应的依赖文件。</p><p>现假设有如下 Makefile 文件</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    objects <span class="token operator">=</span> foo.o bar.o all.result</span>
<span class="line">    all: <span class="token variable"><span class="token variable">$(</span>objects<span class="token variable">)</span></span></span>
<span class="line">        <span class="token variable"><span class="token variable">$(</span>CC<span class="token variable">)</span></span> $^ <span class="token parameter variable">-o</span> all</span>
<span class="line"></span>
<span class="line">    <span class="token variable"><span class="token variable">$(</span>objects<span class="token variable">)</span></span><span class="token builtin class-name">:</span> %.o: %.c</span>
<span class="line">        <span class="token variable"><span class="token variable">$(</span>CC<span class="token variable">)</span></span> <span class="token parameter variable">-c</span> $^ <span class="token parameter variable">-o</span> <span class="token variable">$@</span></span>
<span class="line"></span>
<span class="line">    all.c:</span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;int main() { return 0; }&quot;</span> <span class="token operator">&gt;</span> all.c</span>
<span class="line"></span>
<span class="line">    %.c:</span>
<span class="line">        <span class="token function">touch</span> <span class="token variable">$@</span></span>
<span class="line"></span>
<span class="line">    clean:</span>
<span class="line">        <span class="token function">rm</span> <span class="token parameter variable">-f</span> *.c *.o all</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Outputs</span></span>
<span class="line">    <span class="token comment">#    Makefile:8: target &#39;all.result&#39; doesn&#39;t match the target pattern</span></span>
<span class="line">    <span class="token comment">#    touch foo.c</span></span>
<span class="line">    <span class="token comment">#    cc -c foo.c -o foo.o</span></span>
<span class="line">    <span class="token comment">#    touch bar.c</span></span>
<span class="line">    <span class="token comment">#    cc -c bar.c -o bar.o</span></span>
<span class="line">    <span class="token comment">#    cc -c  -o all.result</span></span>
<span class="line">    <span class="token comment">#    cc: fatal error: no input files</span></span>
<span class="line">    <span class="token comment">#    compilation terminated.</span></span>
<span class="line">    <span class="token comment">#    make: *** [Makefile:9: all.result] Error 1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>过滤函数 <code>filter</code></strong></p><p>上述问题可以先对目标文件使用过滤函数 <code>filter</code> 解决。</p><p>基本语法为</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    <span class="token variable"><span class="token variable">$(</span>filter %.o,<span class="token punctuation">$(</span>obj_files<span class="token punctuation">)</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span> %.o: %.c</span>
<span class="line">        <span class="token variable"><span class="token variable">$(</span>CC<span class="token variable">)</span></span> <span class="token parameter variable">-c</span> $^ <span class="token parameter variable">-o</span> <span class="token variable">$@</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>模式规则</strong></p><p>该规则相较静态模式规则和过滤函数更为通用。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    %.o <span class="token builtin class-name">:</span> %.c</span>
<span class="line">	<span class="token variable"><span class="token variable">$(</span>CC<span class="token variable">)</span></span> <span class="token parameter variable">-c</span> <span class="token variable"><span class="token variable">$(</span>CFLAGS<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>CPPFLAGS<span class="token variable">)</span></span> $<span class="token operator">&lt;</span> <span class="token parameter variable">-o</span> <span class="token variable">$@</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>双冒号（::）规则</strong></p><p>该规则允许为同一目标定义多个规则。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    all: blah</span>
<span class="line"></span>
<span class="line">    blah::</span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello&quot;</span></span>
<span class="line"></span>
<span class="line">    blah::</span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello again&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="命令与执行" tabindex="-1"><a class="header-anchor" href="#命令与执行"><span>命令与执行</span></a></h3><ol><li><p>默认情况下，Make 会在执行规则中的命令前将其输出到控制台。在命令前使用 <code>@</code> 可以禁止该行为（仅对当前命令有效）；使用 <code>make</code> 的 <code>-s</code> 选项会为每条命令的执行添加 <code>@</code>；</p></li><li><p><strong>每条命令的执行都使用新的 <code>shell</code></strong>；</p></li><li><p><code>$</code> 在 Make 中有特殊含义，故可使用 <code>$$</code> 作为 <code>$</code> 的转译；</p></li><li><p>使用 <code>$(MAKE)</code> 可以递归的执行构建过程，如：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    new_contents <span class="token operator">=</span> <span class="token string">&quot;hello:<span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>touch inside_file&quot;</span></span>
<span class="line">    all:</span>
<span class="line">        <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> subdir</span>
<span class="line">        <span class="token builtin class-name">printf</span> <span class="token variable"><span class="token variable">$(</span>new_contents<span class="token variable">)</span></span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/^ //&#39;</span> <span class="token operator">&gt;</span> subdir/makefile</span>
<span class="line">        <span class="token builtin class-name">cd</span> subdir <span class="token operator">&amp;&amp;</span> <span class="token variable"><span class="token variable">$(</span>MAKE<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">    clean:</span>
<span class="line">        <span class="token function">rm</span> <span class="token parameter variable">-rf</span> subdir</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>export</code></p><p>当 Make 构建时，它在其当前环境变量的基础上创建 Make 变量，如：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    <span class="token comment"># Run this with &quot;export shell_env_var=&#39;I am an environment variable&#39;; make&quot;</span></span>
<span class="line">    all:</span>
<span class="line">        <span class="token comment"># Print out the Shell variable</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token variable">$$</span>shell_env_var</span>
<span class="line"></span>
<span class="line">        <span class="token comment"># Print out the Make variable</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span>shell_env_var<span class="token variable">)</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，你可以使用 <code>export</code> 命令将 Make 变量导出到环境变量中以供当前 <code>shell</code> 使用；因此，Make 的这种特性使得其能够调用子进程执行子构建时共享某些变量，如</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    <span class="token assign-left variable">shell_env_var</span><span class="token operator">=</span>Shell <span class="token function">env</span> var, created inside of Make</span>
<span class="line">    <span class="token builtin class-name">export</span> shell_env_var</span>
<span class="line">    all:</span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span>shell_env_var<span class="token variable">)</span></span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token variable">$$</span>shell_env_var</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>.EXPORT_ALL_VARIABLES</code> 会自动为你导出所有 Make 变量。</p></li><li><p><strong><code>define</code> 与命令列表</strong></p><p><code>define</code> 允许你定义变量来存储命令列表（多条命令）。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    one <span class="token operator">=</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">blah</span><span class="token operator">=</span><span class="token string">&quot;I was set!&quot;</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$$</span>blah</span>
<span class="line"></span>
<span class="line">    define two</span>
<span class="line">    <span class="token builtin class-name">export</span> <span class="token assign-left variable">blah</span><span class="token operator">=</span><span class="token string">&quot;I was set!&quot;</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token variable">$$</span>blah</span>
<span class="line">    endef</span>
<span class="line"></span>
<span class="line">    all: </span>
<span class="line">        @echo <span class="token string">&quot;This prints &#39;I was set&#39;&quot;</span></span>
<span class="line">        @<span class="token variable"><span class="token variable">$(</span>one<span class="token variable">)</span></span></span>
<span class="line">        @echo <span class="token string">&quot;This does not print &#39;I was set&#39; because each command runs in a separate shell&quot;</span></span>
<span class="line">        @<span class="token variable"><span class="token variable">$(</span>two<span class="token variable">)</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="条件控制" tabindex="-1"><a class="header-anchor" href="#条件控制"><span>条件控制</span></a></h3><ol><li><p><code>ifeq...else...endif</code></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    foo <span class="token operator">=</span> ok</span>
<span class="line"></span>
<span class="line">    all:</span>
<span class="line">    ifeq <span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>foo<span class="token variable">)</span></span>, ok<span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;foo equals ok&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">&quot;nope&quot;</span></span>
<span class="line">    endif</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>ifneq...endif</code></p></li></ol><h3 id="函数" tabindex="-1"><a class="header-anchor" href="#函数"><span>函数</span></a></h3><p>函数调用形如 <code>$(fn, args)</code> 或 <code>${fn, args}</code></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    <span class="token comment"># 所有的匹配字符均会被替换！！！</span></span>
<span class="line">    bar :<span class="token operator">=</span> <span class="token variable">${subst not<span class="token operator">,</span>&quot;totally&quot;<span class="token operator">,</span> &quot;I am not superman&quot;}</span></span>
<span class="line">    all: </span>
<span class="line">	    @echo <span class="token variable"><span class="token variable">$(</span>bar<span class="token variable">)</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p><strong>字符替换 <code>$(patsubst pattern,replacement,text)</code></strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    foo :<span class="token operator">=</span> a.o b.o l.a c.o</span>
<span class="line">    one :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>patsubst %.o,%.c,<span class="token punctuation">$(</span>foo<span class="token punctuation">)</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Result -&gt; one := a.c b.c l.a c.c</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>循环 <code>$(foreach var,list,text)</code></strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    foo :<span class="token operator">=</span> <span class="token function">who</span> are you</span>
<span class="line">    bar :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach wrd,<span class="token punctuation">$(</span>foo<span class="token punctuation">)</span>,<span class="token punctuation">$(</span>wrd<span class="token punctuation">)</span><span class="token operator">!</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">     <span class="token comment"># Result -&gt; foo := who! are! you!</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>空字符串判断 <code>${if arg, then, else}</code></strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    foo :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span><span class="token keyword">if</span> this-is-not-empty,then<span class="token operator">!</span>,else<span class="token operator">!</span><span class="token variable">)</span></span></span>
<span class="line">    empty :<span class="token operator">=</span></span>
<span class="line">    bar :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span><span class="token keyword">if</span> <span class="token punctuation">$(</span>empty<span class="token punctuation">)</span>,then<span class="token operator">!</span>,else<span class="token operator">!</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">    all:</span>
<span class="line">        @echo <span class="token variable"><span class="token variable">$(</span>foo<span class="token variable">)</span></span></span>
<span class="line">        @echo <span class="token variable"><span class="token variable">$(</span>bar<span class="token variable">)</span></span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># Outputs</span></span>
<span class="line">    <span class="token comment">#   then!</span></span>
<span class="line">    <span class="token comment">#   else!</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>过滤函数 <code>${filter pattern, arg}</code></strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    obj_files <span class="token operator">=</span> foo.result bar.o lose.o</span>
<span class="line">    filtered_files <span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>filter %.o,<span class="token punctuation">$(</span>obj_files<span class="token punctuation">)</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">    all:</span>
<span class="line">        @echo <span class="token variable"><span class="token variable">$(</span>filtered_files<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Result -&gt; filtered_files = bar.o lose.o</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>自定义函数调用 ${call fn_name, arg(s)}</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    sweet_new_fn <span class="token operator">=</span> Variable Name: <span class="token variable"><span class="token variable">$(</span><span class="token number">0</span><span class="token variable">)</span></span> First: <span class="token variable"><span class="token variable">$(</span><span class="token number">1</span><span class="token variable">)</span></span> Second: <span class="token variable"><span class="token variable">$(</span><span class="token number">2</span><span class="token variable">)</span></span> Empty Variable: <span class="token variable"><span class="token variable">$(</span><span class="token number">3</span><span class="token variable">)</span></span></span>
<span class="line">    all:</span>
<span class="line">        @echo <span class="token variable"><span class="token variable">$(</span>call sweet_new_fn, go, tigers<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Outputs &quot;Variable Name: sweet_new_fn First: go Second: tigers Empty Variable:&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>执行 <code>shell</code> 命令 <code>${shell command(s)}</code></strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    all: </span>
<span class="line">        @echo <span class="token variable"><span class="token variable">$(</span>shell <span class="token function">ls</span> <span class="token parameter variable">-la</span><span class="token variable">)</span></span> <span class="token comment"># Very ugly because the newlines are gone!</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="其他特性" tabindex="-1"><a class="header-anchor" href="#其他特性"><span>其他特性</span></a></h3><ol><li><p><strong><code>include</code> 指令</strong> 允许 Make 读取多个 makefile。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    include filenames<span class="token punctuation">..</span>.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong><code>vpath</code> 指令</strong></p><p>默认情况下，Make 会在当前工作目录查找依赖文件；<strong>而 vpath 允许指定在指定目录查找依赖文件</strong>。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">     <span class="token comment"># Syntax</span></span>
<span class="line">     vpath <span class="token operator">&lt;</span>pattern<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>directories<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line">     <span class="token comment"># Example</span></span>
<span class="line">     vpath %.h <span class="token punctuation">..</span>/headers <span class="token punctuation">..</span>/other-directory</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>.PHONY</code> 伪目标</p><p>当 Make 中存在与伪目标同名的目标文件时，该伪目标将失效；因为伪目标没有依赖文件，故其相应命令将永远得不到执行。</p><p>Make 提供了 <code>.PHONY</code> 以避免上述问题。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    .PHONY: clean</span>
<span class="line">    clean:</span>
<span class="line">        <span class="token function">rm</span> <span class="token parameter variable">-f</span> some_file</span>
<span class="line">        <span class="token function">rm</span> <span class="token parameter variable">-f</span> clean</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>.DELETE_ON_ERROR</code></p><p>该特性使得 Make 在某条构建规则中的某个命令失败时（非零返回值），将删除相应的目标文件。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">    .DELETE_ON_ERROR:</span>
<span class="line">    all: one</span>
<span class="line"></span>
<span class="line">    one:</span>
<span class="line">        <span class="token function">touch</span> one</span>
<span class="line">        <span class="token boolean">false</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Outputs</span></span>
<span class="line">    <span class="token comment">#    touch one</span></span>
<span class="line">    <span class="token comment">#    false</span></span>
<span class="line">    <span class="token comment">#    make: *** [Makefile:6: one] Error 1</span></span>
<span class="line">    <span class="token comment">#    make: *** Deleting file &#39;one&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol></div><!--[--><!--]--></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link label" href="https://github.com/mgkl92/mgkl92.github.io/edit/main/docs/tool/makefile.md" aria-label="Edit this page" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><svg class="edit-icon" viewbox="0 0 1024 1024"><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]--><!--]-->Edit this page<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新: </span><time class="meta-item-info" datetime="2025-07-10T14:24:09.000Z" data-allow-mismatch>2025/7/10 14:24</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zst_lff@126.com">mgkl92</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CkPgLnmy.js" defer></script>
  </body>
</html>
